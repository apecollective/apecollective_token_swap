<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trader Joe AVAX Token Swapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <script src="https://unpkg.com/@walletconnect/ethereum-provider"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-6">

  <div class="w-full max-w-md bg-gray-800 p-6 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-6 text-center">Trader Joe AVAX Swapper</h1>

    <button id="walletBtn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded mb-4">Connect Wallet</button>
    <p id="account" class="text-center text-sm mb-6"></p>

    <div>
      <label class="block mb-1">From Token</label>
      <div id="fromDropdown" class="bg-gray-700 rounded p-2 cursor-pointer relative mb-4">
        <span id="fromLabel" class="flex items-center gap-2">Select token</span>
        <div id="fromList" class="absolute top-full left-0 right-0 bg-gray-800 rounded mt-1 shadow-lg max-h-48 overflow-auto hidden z-10"></div>
      </div>
    </div>

    <div>
      <label class="block mb-1">To Token</label>
      <div id="toDropdown" class="bg-gray-700 rounded p-2 cursor-pointer relative mb-4">
        <span id="toLabel" class="flex items-center gap-2">Select token</span>
        <div id="toList" class="absolute top-full left-0 right-0 bg-gray-800 rounded mt-1 shadow-lg max-h-48 overflow-auto hidden z-10"></div>
      </div>
    </div>

    <label class="block mb-1">Amount</label>
    <input id="amountInput" type="number" min="0" step="any" placeholder="0.1" class="w-full p-2 mb-4 rounded bg-gray-700 border border-gray-600 text-white" />

    <p id="priceEstimate" class="text-gray-400 text-center mb-4"></p>

    <button id="swapBtn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded disabled:opacity-50" disabled>Swap Now</button>

    <p id="status" class="text-center mt-4"></p>
  </div>

  <script>
    const ROUTER_ADDRESS = "0x60aE616a2155Ee3d9A68541Ba4544862310933d4";
    const WAVAX = "0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7";

    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    const ROUTER_ABI = [
      "function swapExactAVAXForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable returns (uint[] memory amounts)",
      "function swapExactTokensForAVAX(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) returns (uint[] memory amounts)",
      "function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)"
    ];

    const TOKENS = {
      AVAX: {
        symbol: "AVAX",
        address: null,
        logo: "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png",
      },
      "USDC.e": {
        symbol: "USDC.e",
        address: "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E",
        logo: "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/assets/0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E/logo.png",
      },
      "DAI.e": {
        symbol: "DAI.e",
        address: "0xd586E7F844cEa2F87f50152665BCbc2C279D8d70",
        logo: "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/assets/0xd586E7F844cEa2F87f50152665BCbc2C279D8d70/logo.png",
      },
    };

    let web3Modal, provider, ethersProvider, signer, userAddress = null;
    let fromToken = "AVAX";
    let toToken = "USDC.e";

    const walletBtn = document.getElementById("walletBtn");
    const accountP = document.getElementById("account");
    const fromDropdown = document.getElementById("fromDropdown");
    const toDropdown = document.getElementById("toDropdown");
    const fromList = document.getElementById("fromList");
    const toList = document.getElementById("toList");
    const fromLabel = document.getElementById("fromLabel");
    const toLabel = document.getElementById("toLabel");
    const amountInput = document.getElementById("amountInput");
    const priceEstimate = document.getElementById("priceEstimate");
    const swapBtn = document.getElementById("swapBtn");
    const statusP = document.getElementById("status");

    window.addEventListener("load", initWeb3Modal);

    function initWeb3Modal() {
      web3Modal = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions: {
          walletconnect: {
            package: window.WalletConnectProvider.default,
            options: {
              rpc: { 43114: "https://api.avax.network/ext/bc/C/rpc" },
              chainId: 43114
            }
          }
        },
        theme: "dark"
      });

      if (web3Modal.cachedProvider) {
        connectWallet();
      }

      walletBtn.onclick = () => {
        if (userAddress) {
          disconnectWallet();
        } else {
          connectWallet();
        }
      };
    }

    async function connectWallet() {
      try {
        provider = await web3Modal.connect();
        ethersProvider = new ethers.providers.Web3Provider(provider);
        signer = ethersProvider.getSigner();
        userAddress = await signer.getAddress();

        provider.on("accountsChanged", () => location.reload());
        provider.on("disconnect", disconnectWallet);

        accountP.textContent = `Connected: ${userAddress}`;
        walletBtn.textContent = "Disconnect Wallet";
        walletBtn.classList.replace("bg-blue-600", "bg-red-600");
        walletBtn.classList.replace("hover:bg-blue-700", "hover:bg-red-700");

        router = new ethers.Contract(ROUTER_ADDRESS, ROUTER_ABI, signer);
        await updateBalances();
        enableSwapIfReady();
      } catch (err) {
        console.error("Connection failed", err);
      }
    }

    async function disconnectWallet() {
      if (provider?.disconnect) await provider.disconnect();
      await web3Modal.clearCachedProvider();

      provider = signer = userAddress = router = null;

      accountP.textContent = "";
      walletBtn.textContent = "Connect Wallet";
      walletBtn.classList.replace("bg-red-600", "bg-blue-600");
      walletBtn.classList.replace("hover:bg-red-700", "hover:bg-blue-700");
      fromLabel.textContent = "Select token";
      toLabel.textContent = "Select token";
      amountInput.value = "";
      priceEstimate.textContent = "";
      swapBtn.disabled = true;
    }

    async function updateBalances() {
      fromList.innerHTML = "";
      toList.innerHTML = "";

      for (const key in TOKENS) {
        const token = TOKENS[key];
        let balance = "0.0000";

        try {
          if (!token.address) {
            const bal = await ethersProvider.getBalance(userAddress);
            balance = parseFloat(ethers.utils.formatEther(bal)).toFixed(4);
          } else {
            const contract = new ethers.Contract(token.address, ERC20_ABI, ethersProvider);
            const rawBal = await contract.balanceOf(userAddress);
            const decimals = await contract.decimals();
            balance = parseFloat(ethers.utils.formatUnits(rawBal, decimals)).toFixed(4);
          }
        } catch {}

        const itemFrom = createDropdownItem(token, balance, key, true);
        const itemTo = createDropdownItem(token, balance, key, false);
        fromList.appendChild(itemFrom);
        toList.appendChild(itemTo);
      }

      setFromToken(fromToken);
      setToToken(toToken);
    }

    function createDropdownItem(token, balance, key, isFrom) {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 px-4 py-2 hover:bg-gray-600 cursor-pointer";
      div.innerHTML = `<img src="${token.logo}" class="w-5 h-5 rounded-full" /> ${token.symbol} (${balance})`;
      div.onclick = () => {
        isFrom ? setFromToken(key) : setToToken(key);
        hideDropdowns();
        estimatePrice();
      };
      return div;
    }

    function setFromToken(key) {
      fromToken = key;
      fromLabel.innerHTML = `<img src="${TOKENS[key].logo}" class="w-5 h-5 rounded-full" /> ${TOKENS[key].symbol}`;
      enableSwapIfReady();
    }

    function setToToken(key) {
      toToken = key;
      toLabel.innerHTML = `<img src="${TOKENS[key].logo}" class="w-5 h-5 rounded-full" /> ${TOKENS[key].symbol}`;
      enableSwapIfReady();
    }

    function hideDropdowns() {
      fromList.classList.add("hidden");
      toList.classList.add("hidden");
    }

    fromDropdown.onclick = () => {
      toList.classList.add("hidden");
      fromList.classList.toggle("hidden");
    };
    toDropdown.onclick = () => {
      fromList.classList.add("hidden");
      toList.classList.toggle("hidden");
    };

    amountInput.addEventListener("input", () => {
      enableSwapIfReady();
      estimatePrice();
    });

    function enableSwapIfReady() {
      const amount = parseFloat(amountInput.value);
      swapBtn.disabled = !userAddress || fromToken === toToken || !amount || amount <= 0;
    }

    swapBtn.onclick = async () => {
      if (!userAddress) return alert("Connect wallet first");
      if (fromToken === toToken) return alert("From and To tokens must be different");

      const amount = amountInput.value;
      if (!amount || isNaN(amount) || amount <= 0) return alert("Enter a valid amount");

      try {
        swapBtn.disabled = true;
        statusP.textContent = "Swapping... Please confirm in wallet.";

        const amountIn = ethers.utils.parseEther(amount);
        const deadline = Math.floor(Date.now() / 1000) + 1200;
        let tx;

        if (fromToken === "AVAX") {
          const path = [WAVAX, TOKENS[toToken].address];
          tx = await router.swapExactAVAXForTokens(0, path, userAddress, deadline, { value: amountIn });
        } else if (toToken === "AVAX") {
          const tokenContract = new ethers.Contract(TOKENS[fromToken].address, ERC20_ABI, signer);
          await tokenContract.approve(ROUTER_ADDRESS, amountIn);
          const path = [TOKENS[fromToken].address, WAVAX];
          tx = await router.swapExactTokensForAVAX(amountIn, 0, path, userAddress, deadline);
        } else {
          alert("Only AVAX <> Token swaps supported.");
          return;
        }

        statusP.textContent = `Tx sent: ${tx.hash}`;
        await tx.wait();
        statusP.textContent = "✅ Swap successful!";
        await updateBalances();
        amountInput.value = "";
        priceEstimate.textContent = "";
      } catch (err) {
        statusP.textContent = `❌ Swap failed: ${err.message || err}`;
      }

      swapBtn.disabled = false;
    };

    async function estimatePrice() {
      priceEstimate.textContent = "";
      if (!userAddress || !fromToken || !toToken) return;
      const amount = amountInput.value;
      if (!amount || isNaN(amount) || amount <= 0) return;

      try {
        const amountIn = ethers.utils.parseEther(amount);
        let path;

        if (fromToken === "AVAX") {
          path = [WAVAX, TOKENS[toToken].address];
        } else if (toToken === "AVAX") {
          path = [TOKENS[fromToken].address, WAVAX];
        } else {
          priceEstimate.textContent = "Estimation only for AVAX <> Token swaps.";
          return;
        }

        const amountsOut = await router.getAmountsOut(amountIn, path);
        const outAmount = ethers.utils.formatEther(amountsOut[1]);
        priceEstimate.textContent = `Estimated output: ${parseFloat(outAmount).toFixed(6)} ${toToken}`;
      } catch {
        priceEstimate.textContent = "Could not estimate price.";
      }
    }
  </script>
</body>
</html>
